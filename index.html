<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Ficha ONE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Vue 3 via CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <!-- Owlbear Rodeo SDK -->
    <script src="https://cdn.owlbear.rodeo/obr.js"></script>

    <style>
      /* ======== TEMA GLOBAL ======== */
      body {
        font-family: "Inter", sans-serif;
        background: #0F0F1F;
        margin: 0;
        padding: 0;
        color: #EDECF7;
      }

      #app {
        max-width: 900px;
        margin: auto;
        background: linear-gradient(145deg, #1A1B2E, #1C1D33);
        padding: 20px;
        margin-top: 20px;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.6);
      }

      /* ======== MENU ======== */
      nav {
        display: flex;
        gap: 6px;
        margin-bottom: 12px;
      }

      nav button {
        flex: 1;
        padding: 6px 8px;
        font-size: 13px;
        background: linear-gradient(135deg, #2C2D3F, #252634);
        border: none;
        border-radius: 8px;
        font-weight: 600;
        color: #EDECF7;
        cursor: pointer;
        transition: 0.3s;
      }

      nav button.active {
        background: linear-gradient(135deg, #7C5CFF, #9B7BFF);
        color: white;
      }

      /* ======== T√çTULO ======== */
      h1 {
        margin-top: 10px;
        font-weight: 700;
        color: #EDECF7;
        text-align: center;
        margin-bottom: 6px;
        letter-spacing: -1px;
      }

      .sheet, .master {
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      /* ======== CAMPOS ======== */
      .field {
        display: flex;
        flex-direction: column;
        background: linear-gradient(145deg, #2C2D3F, #252634);
        border: none;
        border-radius: 12px;
        padding: 10px;
        margin-top: 2px;
      }

      .field label {
        font-weight: 600;
        margin-bottom: 3px;
        color: #CFCFF5;
      }

      input, select, textarea {
        padding: 8px;
        border-radius: 8px;
        border: none;
        font-size: 14px;
        background: #1A1B2E;
        color: #EDECF7;
      }

      textarea {
        resize: vertical;
      }

      /* ======== VIDA / MANA / TIPO / ATRIBUTO ======== */
      .stats-row {
        display: flex;
        gap: 10px;
        margin-bottom: 6px;
      }

      .stat-box {
        flex: 1;
        background: linear-gradient(145deg, #2C2D3F, #252634);
        border: none;
        padding: 10px;
        border-radius: 12px;
        text-align: center;
      }

      .stat-box button:hover {
        transform: scale(1.1);
      }

      .stat-box .label {
        font-weight: 600;
        margin-bottom: 3px;
        color: #CFCFF5;
      }

      .stat-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        margin-top: 6px;
      }

      .stat-controls button {
        width: 28px;
        height: 28px;
        background: linear-gradient(135deg, #7C5CFF, #9B7BFF);
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        color: white;
        cursor: pointer;
        padding: 0;
        transition: 0.3s;
      }

      .stat-controls button:hover {
        transform: scale(1.05);
      }

      .stat-controls .value {
        font-size: 20px;
        font-weight: bold;
        color: #EDECF7;
      }

      /* ======== BOX DAS FICHAS ======== */
      .ficha {
        background: linear-gradient(145deg, #2C2D3F, #252634);
        border: none;
        border-radius: 12px;
        padding: 12px;
        margin-bottom: 8px;
        color: #EDECF7;
      }

      .ficha h2 {
        margin: 0 0 5px 0;
        font-size: 18px;
        font-weight: 700;
      }

      .ficha p {
        margin: 2px 0;
      }
      .master p { 
        font-size: 15px
      }
      .master h2 { 
        font-size: 17px
      }
    </style>
  </head>
  <body>
    <div id="app"></div>

    <script>
      const { createApp } = Vue;

      const App = {
        data() {
          return {
            page: "player",
            nome: "",
            vida: 3,
            ruina: 3,
            tipo: "Combatente",
            atributo: "For√ßa",
            inventario: "",
            ultimoResultado: "",
            ultimasRolagens: [],
            ultimasRolagensVisiveis: false,
            fichas: {},
            salvarTimeout: null,
            logs: [],
            isMestre: false,
            rolando: false,
            monstros: [],
            _acoes: 3,
            filaSalvamento: [],
            processandoFila: false,
            ultimoSalvamento: 0,
            atualizandoFicha: false,
          };
        },

        mounted() {
          this.log("‚è≥ Aguardando OBR...");

          OBR.onReady(async () => {
            this.log("‚úÖ OBR carregado!");

            try {
              const playerId = await OBR.player.getId();
              this.log("üéÆ Meu ID: " + playerId);

              const role = await OBR.player.getRole();
              this.isMestre = role === "GM";
              this.log("üé© Papel detectado: " + role);

              const roomData = await OBR.room.getMetadata();
              const fichasAtuais = {};

              for (const [key, value] of Object.entries(roomData)) {
                if (key.startsWith("ficha-")) {
                  value.ultimasRolagens = this.normalizarRolagens(value.ultimasRolagens);
                  fichasAtuais[key] = value;
                }
              }

              this.fichas = fichasAtuais;

              // Carrega a pr√≥pria ficha
              const minhaFicha = roomData[`ficha-${playerId}`];
              if (minhaFicha) {
                Object.assign(this, minhaFicha);
                this.ultimasRolagens = this.normalizarRolagens(minhaFicha.ultimasRolagens);
                if (this._acoes === undefined) this._acoes = minhaFicha._acoes ?? 3;
              } else {
                this._acoes = 3;
              }

              // Carrega monstros salvos
              if (roomData.monstros) {
                const valores = roomData.monstros.split("|").map(Number);
                this.monstros = valores.map(v => ({ vida: v }));
              }

              // Listener para atualiza√ß√£o em tempo real
              OBR.room.onMetadataChange((metadata) => {
                if (this.atualizandoFicha) return;

                const minhaFichaId = `ficha-${playerId}`;

                // Monstros
                if (metadata.monstros !== undefined) {
                  const valores = metadata.monstros.split("|").map(Number);
                  this.monstros = valores.map(v => ({ vida: v }));
                }

                // Fichas de outros jogadores
                for (const [key, value] of Object.entries(metadata)) {
                  if (key.startsWith("ficha-") && key !== minhaFichaId) {
                    const rolagensNormalizadas = this.normalizarRolagens(value.ultimasRolagens);

                    if (!this.fichas[key]) {
                      this.fichas[key] = { 
                        ...value, 
                        ultimasRolagens: rolagensNormalizadas,
                        _acoes: value._acoes ?? 3
                      };
                    } else {
                      // Atualiza apenas se mudou
                      if (JSON.stringify(this.fichas[key].ultimasRolagens) !== JSON.stringify(rolagensNormalizadas)) {
                        this.fichas[key].ultimasRolagens = rolagensNormalizadas;
                      }
                      if (this.fichas[key].ultimoResultado !== value.ultimoResultado) {
                        this.fichas[key].ultimoResultado = value.ultimoResultado;
                      }
                      this.fichas[key].vida = value.vida;
                      this.fichas[key].ruina = value.ruina;
                      this.fichas[key].nome = value.nome;
                      this.fichas[key].tipo = value.tipo;
                      this.fichas[key].atributo = value.atributo;
                      this.fichas[key].inventario = value.inventario;
                      if (value._acoes !== undefined) this.fichas[key]._acoes = value._acoes;
                    }
                  }
                }
              });
            } catch (e) {
              this.log("‚ùå Erro na inicializa√ß√£o: " + (e.message || e));
            }
          });
        },

        watch: {
          nome: "salvarFicha",
          vida(value) {
            if (value < 0) this.vida = 0;
            this.salvarFicha();
          },
          ruina(value) {
            if (value < 0) this.ruina = 0;
            this.salvarFicha();
          },
          tipo: "salvarFicha",
          atributo: "salvarFicha",
          inventario: "salvarFicha",
        },

        methods: {
          normalizarRolagens(v) {
            if (!v) return [];
            if (Array.isArray(v)) return v;
            if (typeof v === "string") return v.split("|");
            return [];
          },

          // Fila de salvamento - vers√£o simplificada
          async adicionarNaFila(payload, playerId) {
            this.filaSalvamento.push({ payload, playerId, timestamp: Date.now() });
            this.log(`üì¶ Adicionado na fila: ${payload.nome} (${this.filaSalvamento.length} na fila)`);

            if (!this.processandoFila) {
              this.processarFila();
            }
          },

          async processarFila() {
            if (this.processandoFila || this.filaSalvamento.length === 0) return;
            
            this.processandoFila = true;
            this.log("üöÄ Iniciando processamento da fila...");

            // Processa um item por vez de forma sequencial
            const processarSequencialmente = async () => {
              const items = [...this.filaSalvamento]; // Cria uma c√≥pia
              this.filaSalvamento = []; // Limpa a fila original

              for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const agora = Date.now();

                // Espera pelo menos 500ms entre salvamentos
                if (agora - this.ultimoSalvamento < 500) {
                  await new Promise(r => setTimeout(r, 500 - (agora - this.ultimoSalvamento)));
                }

                try {
                  await OBR.room.setMetadata({
                    [`ficha-${item.playerId}`]: item.payload
                  });

                  this.ultimoSalvamento = Date.now();
                  this.log(`‚úÖ Salvado da fila: ${item.payload.nome} (${items.length - i - 1} restantes)`);
                  
                  // Pequena pausa entre itens
                  await new Promise(r => setTimeout(r, 100));
                  
                } catch (e) {
                  this.log(`‚ùå Erro ao salvar ${item.payload.nome}: ${e.message}`);
                }
              }

              this.processandoFila = false;
              this.log("üéØ Fila de salvamento conclu√≠da");
            };

            // Inicia o processamento
            processarSequencialmente();
          },

          async salvarFicha() {
            clearTimeout(this.salvarTimeout);

            this.salvarTimeout = setTimeout(async () => {
              try {
                const playerId = await OBR.player.getId();
                this.atualizandoFicha = true;

                const payload = {
                  nome: this.nome,
                  vida: this.vida,
                  ruina: this.ruina,
                  tipo: this.tipo,
                  atributo: this.atributo,
                  inventario: this.inventario,
                  ultimoResultado: this.ultimoResultado,
                  ultimasRolagens: this.ultimasRolagens.join("|"),
                };

                if (this.isMestre) payload._acoes = this._acoes;

                this.adicionarNaFila(payload, playerId);

                setTimeout(() => this.atualizandoFicha = false, 500);
              } catch (e) {
                this.log("‚ùå Erro ao preparar salvamento: " + e.message);
                this.atualizandoFicha = false;
              }
            }, 800);
          },

          trocarPagina(p) {
            this.page = p;
          },

          async salvarMonstros() {
            try {
              await OBR.room.setMetadata({
                monstros: this.monstros.map(m => m.vida).join("|"),
              });
            } catch (e) {
              this.log("‚ùå Erro ao salvar monstros: " + e.message);
            }
          },

          adicionarMonstro() {
            this.monstros.push({ vida: 10 });
            this.salvarMonstros();
          },

          limparMonstros() {
            if (!confirm("Deseja remover todos os monstros?")) return;
            this.monstros = [];
            this.salvarMonstros();
          },

          async limparFichas() {
            if (!this.isMestre) return;
            if (!confirm("Tem certeza que deseja limpar todas as fichas dos jogadores?")) return;

            try {
              const roomData = await OBR.room.getMetadata();
              const updates = {};
              for (const key of Object.keys(roomData)) {
                if (key.startsWith("ficha-")) updates[key] = undefined;
              }
              await OBR.room.setMetadata(updates);
              this.fichas = {};
              this.log("üßπ Todas as fichas foram limpas!");
            } catch (e) {
              this.log("‚ùå Erro ao limpar fichas: " + (e.message || e));
            }
          },

          toggleUltimasRolagens() {
            this.ultimasRolagensVisiveis = !this.ultimasRolagensVisiveis;
          },

          async rolarDado(max, tipo) {
            if (this.rolando) return;
            this.rolando = true;

            // Simula som de dado (pode substituir por arquivo real)
            try {
              const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==');
              audio.play().catch(() => {}); // Ignora erros de √°udio
            } catch (e) {}

            await new Promise(res => setTimeout(res, 1000));

            const valor = Math.floor(Math.random() * max) + 1;
            const novaRolagem = `${tipo} ‚Üí ${valor}`;

            this.ultimasRolagens.unshift(novaRolagem);
            if (this.ultimasRolagens.length > 3) this.ultimasRolagens.pop();

            this.ultimoResultado = novaRolagem;
            this.salvarFicha();
            this.log(`${this.nome} üé≤ ${tipo}: ${valor}`);

            this.rolando = false;
          },

          rolarD10() { return this.rolarDado(10, "D10"); },
          rolarD4() { return this.rolarDado(4, "D4"); },

          log(msg) {
            this.logs.unshift(new Date().toLocaleTimeString() + " " + msg);
            if (this.logs.length > 20) this.logs.pop();
          },

          async atualizarRolagens() {
            try {
              this.log("üîç Verificando rolagens pendentes...");
              const roomData = await OBR.room.getMetadata();
              const playerId = await OBR.player.getId();
              let atualizacoes = 0;

              for (const [key, value] of Object.entries(roomData)) {
                if (key.startsWith("ficha-") && key !== `ficha-${playerId}`) {
                  const rolagensNormalizadas = this.normalizarRolagens(value.ultimasRolagens);
                  const fichaAtual = this.fichas[key];

                  if (fichaAtual) {
                    const rolagensAtuais = fichaAtual.ultimasRolagens.join('|');
                    const rolagensNovas = rolagensNormalizadas.join('|');

                    if (rolagensAtuais !== rolagensNovas) {
                      const outroPlayerId = key.replace('ficha-', '');
                      this.adicionarNaFila({
                        ...value,
                        ultimasRolagens: value.ultimasRolagens,
                        ultimoResultado: value.ultimoResultado
                      }, outroPlayerId);

                      atualizacoes++;
                      this.log(`üì¶ ${fichaAtual.nome}: Adicionado na fila para sincronizar`);
                    }
                  }
                }
              }

              if (atualizacoes > 0) this.log(`üîÑ ${atualizacoes} fichas na fila para sincroniza√ß√£o`);
              else this.log("üí° Todas as fichas j√° est√£o sincronizadas");
            } catch (e) {
              this.log("‚ùå Erro ao verificar rolagens: " + e.message);
            }
          },

          async alterarAcoes(id, novoValor) {
            const fichaAtual = this.fichas[id];
            if (!fichaAtual) return;

            const fichaParaSalvar = {
              nome: fichaAtual.nome,
              vida: fichaAtual.vida,
              ruina: fichaAtual.ruina,
              tipo: fichaAtual.tipo,
              atributo: fichaAtual.atributo,
              inventario: fichaAtual.inventario,
              ultimoResultado: fichaAtual.ultimoResultado,
              ultimasRolagens: (fichaAtual.ultimasRolagens || []).join("|"),
              _acoes: novoValor,
            };

            try {
              const playerId = id.replace('ficha-', '');
              this.adicionarNaFila(fichaParaSalvar, playerId);
              this.log(`üîß GM alterou a√ß√µes de ${fichaAtual.nome} para ${novoValor}`);
            } catch (e) {
              this.log("‚ùå Erro ao alterar a√ß√µes: " + e.message);
            }
          }
        },

        template: `
          <div>
            <nav>
              <button :class="{active: page==='player'}" @click="trocarPagina('player')">Jogador</button>
              <button v-if="isMestre" :class="{active: page==='master'}" @click="trocarPagina('master')">Mestre</button>
            </nav>

            <!-- Player -->
            <div v-if="page==='player'" class="sheet">
              <div class="field">
                <label>Nome</label>
                <input v-model="nome" placeholder="Digite o nome" />
              </div>

              <div class="stats-row">
                <div class="stat-box">
                  <span class="label">Vida</span>
                  <div class="stat-controls">
                    <button @click="vida--">‚àí</button>
                    <span class="value">{{ vida }}</span>
                    <button @click="vida++">+</button>
                  </div>
                </div>

                <div class="stat-box">
                  <span class="label">Ruina</span>
                  <div class="stat-controls">
                    <button @click="ruina--">‚àí</button>
                    <span class="value">{{ ruina }}</span>
                    <button @click="ruina++">+</button>
                  </div>
                </div>
              </div>

              <div class="stats-row">
                <div class="stat-box" style="text-align:center;">
                  <label class="label" style="margin-bottom:6px; display:block;">Fun√ß√£o</label>
                  <select v-model="tipo" style="width:100%;text-align:center;">
                    <option>Combatente</option>
                    <option>Arruinado</option>
                  </select>
                </div>

                <div class="stat-box" style="text-align:center;">
                  <label class="label" style="margin-bottom:6px; display:block;">Atributo</label>
                  <select v-model="atributo" style="width:100%; text-align:center;">
                    <option>For√ßa</option>
                    <option>Destreza</option>
                    <option>Intelecto</option>
                    <option>Vigor</option>
                  </select>
                </div>
              </div>

              <div class="stats-row">
                <div class="stat-box" style="padding: 14px;">
                  <button
                    @click="rolarD10"
                    :disabled="rolando"
                    style="width:100%; padding:8px; border-radius:8px; border:none; background:linear-gradient(135deg, #7C5CFF, #9B7BFF); color:white; font-weight:700; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 2px 6px rgba(0,0,0,0.4); cursor:pointer;"
                  >
                    Rolar D10
                  </button>
                </div>

                <div class="stat-box" style="padding: 14px;">
                  <button
                    @click="rolarD4"
                    :disabled="rolando"
                    style="width:100%; padding:8px; border-radius:8px; border:none; background:linear-gradient(135deg, #7C5CFF, #9B7BFF); color:white; font-weight:700; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 2px 6px rgba(0,0,0,0.4); cursor:pointer;"
                  >
                    Rolar D4
                  </button>
                </div>
              </div>

              <div class="field" v-if="ultimoResultado" style="position:relative; display:flex; flex-direction:column; align-items:flex-start;">
                <div style="display:flex; align-items:center; gap:6px; width:100%; position:relative;">
                  <label>Resultado</label>
                  <div style="font-size:22px; font-weight:bold; flex-shrink:0;">
                    {{ ultimoResultado }}
                  </div>
                  <button
                    @click="toggleUltimasRolagens"
                    style="margin-left:auto; font-size:12px; padding:2px 4px; border-radius:4px; border:none; cursor:pointer; background:#7C5CFF; color:white; position:relative; z-index:1;"
                  >
                    ‚ü≥
                  </button>
                  <div v-if="ultimasRolagensVisiveis"
                    style="position:absolute; bottom: 30px; right: 0; background:#222; color:white; border:1px solid #444; border-radius:6px; padding:6px 10px; box-shadow:0 2px 6px rgba(0,0,0,0.5); z-index:100; white-space:nowrap;"
                  >
                    <div v-for="(r, i) in (ultimasRolagens || [])" :key="i" style="font-size:14px;">
                      {{ r }}
                    </div>
                  </div>
                </div>
              </div>

              <div class="field">
                <label>Invent√°rio</label>
                <textarea v-model="inventario" rows="5" placeholder="Anote itens"></textarea>
              </div>
            </div>

            <!-- Mestre -->
            <div v-if="page==='master' && isMestre" class="master">
              <div style="text-align: center; margin-bottom: 10px;">
                <button
                  @click="limparFichas"
                  style="width: 80px; padding: 4px 8px; background: linear-gradient(135deg, #7C5CFF, #9B7BFF); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 2px 6px rgba(0,0,0,0.4);"
                >
                  Limpar
                </button>
                <button
                  @click="atualizarRolagens"
                  :disabled="processandoFila"
                  style="padding:6px 12px; background:#28a745; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer; margin-left: 10px;"
                >
                  üîÑ {{ processandoFila ? `Processando... (${filaSalvamento.length})` : 'Sincronizar' }}
                </button>
              </div>

              <div v-if="Object.keys(fichas).length === 0">
                Nenhum jogador conectado ainda.
              </div>

              <div v-for="(ficha, id) in fichas" :key="id" class="ficha">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                  <h2 style="margin:0;">{{ ficha.nome || 'Sem nome' }} | {{ ficha.tipo }}</h2>
                  <div class="stat-controls" style="display:flex; align-items:center; gap:6px;">
                    <button @click="alterarAcoes(id, (ficha._acoes ?? 3) - 1)">‚àí</button>
                    <span style="display:inline-block;">{{ ficha._acoes ?? 3 }}</span>
                    <button @click="alterarAcoes(id, (ficha._acoes ?? 3) + 1)">+</button>
                  </div>
                </div>
                <p>Vida: {{ ficha.vida }} | Ruina: {{ ficha.ruina }} | {{ ficha.atributo }}</p>
                <p style="font-size:12px;">{{ ficha.inventario }}</p>
                <p>{{ ficha.ultimasRolagens.length ? ficha.ultimasRolagens.join(' | ') : '‚Äî' }}</p>
              </div>

              <!-- MONSTROS -->
              <div>
                <div style="display:flex; justify-content:center; gap:10px; margin-bottom:15px;">
                  <button
                    @click="adicionarMonstro"
                    style="padding:6px 12px; background:linear-gradient(135deg, #7C5CFF, #9B7BFF); color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;"
                  >
                    Adicionar Monstro
                  </button>
                  <button
                    @click="limparMonstros"
                    style="padding:6px 12px; background:#b00000; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;"
                  >
                    Limpar
                  </button>
                </div>

                <div v-if="monstros.length === 0" style="text-align:center; opacity:0.6;">
                  Nenhum monstro criado.
                </div>

                <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:12px;">
                  <div v-for="(m, index) in monstros" :key="index">
                    <div style="padding:6px; padding-top:0;">
                      <div class="stats-row" style="margin:0;">
                        <div class="stat-box">
                          <span class="label">Monstro {{ index + 1 }}</span>
                          <div class="stat-controls">
                            <button @click="m.vida--">‚àí</button>
                            <span class="value">{{ m.vida }}</span>
                            <button @click="m.vida++">+</button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Debug -->
              <div
                v-if="page === 'master' && isMestre"
                style="margin-top:20px; background:#111; padding:10px; border-radius:8px; max-height:150px; overflow:auto;"
              >
                <h3>Debug:</h3>
                <div v-for="(log, i) in logs" :key="i" style="font-size:12px;">{{ log }}</div>
              </div>
            </div>
          </div>
        `
      };

      createApp(App).mount('#app');
    </script>
  </body>
</html>
